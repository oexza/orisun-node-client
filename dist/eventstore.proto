syntax = "proto3";

package orisun;

option go_package = "github.com/oexza/Orisun/orisun";
option java_package = "com.orisun.eventstore";

import "google/protobuf/timestamp.proto";

message Position {
  int64 commit_position = 1;
  int64 prepare_position = 2;
}

message Tag {
  string key = 1;
  string value = 2;
}

message Criterion {
  repeated Tag tags = 1;
}

message Query {
  repeated Criterion criteria = 1;
}

message EventToSave {
  string event_id = 1;
  string event_type = 2;
  string data = 3;
  string metadata = 4;
}

message Event {
  string event_id = 1;
  string event_type = 2;
  string data = 3;
  string metadata = 4;
  Position position = 6;
  google.protobuf.Timestamp date_created = 7;
}

message WriteResult {
  Position log_position = 1;
}

enum Direction {
  ASC = 0;
  DESC = 1;
}

message SaveQuery{
  Position expected_position = 1;
  Query subsetQuery = 2;
}

message SaveEventsRequest {
  string boundary = 2;
  SaveQuery query = 3;
  repeated EventToSave events = 4;
}

message GetEventsRequest {
  Query query = 1;
  Position from_position = 2;
  uint32 count = 3;
  Direction direction = 4;
  string boundary = 5;
}

message GetEventsResponse {
  repeated Event events = 1;
}

message CatchUpSubscribeToEventStoreRequest {
  Position after_position = 1;
  Query query = 2;
  string subscriber_name = 3;
  string boundary = 4;
}

message PingRequest {}
message PingResponse {}

service EventStore {
  rpc SaveEvents(SaveEventsRequest) returns (WriteResult) {}
  rpc GetEvents(GetEventsRequest) returns (GetEventsResponse) {}
  rpc CatchUpSubscribeToEvents(CatchUpSubscribeToEventStoreRequest) returns (stream Event) {}
  rpc Ping(PingRequest) returns (PingResponse) {}
}